<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CamFlea</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="modal-system.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="loading-screen.css">

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(to right, #e0eafc, #cfdef3); /* Subtle blue gradient copied from Login_page.html */
            overflow-x: hidden; /* Hide horizontal scrollbar */
            overflow-y: auto; /* Enable vertical scrollbar */
        }
        html {
            overflow-x: hidden; /* Hide horizontal scrollbar */
            overflow-y: auto; /* Enable vertical scrollbar */
            font-size: 16px; /* Base font size for rem units */
        }
        .navbar {
            background-color: #069210;
            padding: 10px 40px;
            height: 100px;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            z-index: 9999;
        }
        /* .main-content in the navbar (as per user's reference) */
        .main-content {
            position: absolute;
            left: 50%;
            top: 40%; /* Moved up from 50% to 40% */
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            gap: 30px;
            width: 90%;
            max-width: 1000px;
            flex-grow: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: center;
            padding-left: 120px;
        }
        .logo {
            height: 50px;
            width: auto;
            flex-shrink: 0;
        }
        .search-bar {
            flex-grow: 1;
            position: relative;
            min-width: 500px;
        }
        .search-bar input {
            width: 100%;
            padding: 12px 40px 12px 20px;
            border: none;
            border-radius: 0;
            outline: none;
            font-size: 16px;
            padding-right: 0;
        }
        .search-icon {
            position: absolute;
            right: 15px; /* Moved back to the left */
            top: 50%;
            transform: translateY(-50%);
            height: 18px;
            width: 18px;
            padding: 8px 12px; /* Increased padding for wider background */
            background-color: #069210;
            border-radius: 2px;
            cursor: pointer;
            box-sizing: content-box; /* Ensures padding doesn't affect icon size */
            padding-left: 20px;
            padding-right: 20px;
        }
        .ask-ai-container {
            display: flex;
            align-items: center;
            gap: 5px; 
            flex-shrink: 0;
            margin-left: 20px;
        }
        .ask-ai {
            color: white;
            font-size: 18px;
        }
        .ask-ai-icon {
            height: 28px;
            width: 28px;
        }
        .profile-section {
            position: absolute;
            left: 40px;
            top: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }
        .profile-icon {
            height: 18px;
            width: 18px;
        }
        .notifications-container {
            position: absolute;
            right: 100px;
            top: 15px;
            display: flex;
            gap: 20px;
            color: white;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .nav-icon {
            height: 18px;
            width: 18px;
        }

        .logout {
            color: white;
            text-decoration: none;
        }
        .link{
            color: white;
            text-decoration: none;
        }

        /* Sidebar Styles for Search Filter (as per user's reference) */
        .search-filter-sidebar {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 280px; /* Fixed width for larger screens */
            flex-shrink: 0; /* Prevent shrinking */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        @media screen and (max-width: 1400px) {
            .search-filter-sidebar {
                width: 250px; /* Slightly smaller width */
            }

            .main-content:not(.navbar .main-content) {
                 max-width: calc(100% - 250px - 15px); /* Adjust max-width */
            }
        }

        /* Enhanced Tablet Responsive Design (1024px - 769px) */
        @media screen and (max-width: 1024px) and (min-width: 769px) {
            .navbar {
                padding: 8px 20px;
                height: 80px;
            }
            
            .main-content {
                padding-left: 80px;
                gap: 20px;
                max-width: 900px;
            }
            
            .search-bar {
                min-width: 350px;
                flex-grow: 1;
            }
            
            .search-bar input {
                padding: 10px 35px 10px 15px;
                font-size: 14px;
            }
            
            .search-icon {
                right: 10px;
                padding: 6px 15px;
            }
            
            .logo {
                height: 40px;
            }
            
            .ask-ai {
                font-size: 16px;
            }
            
            .ask-ai-icon {
                height: 24px;
                width: 24px;
            }
            
            .search-filter-sidebar {
                width: 200px;
                padding: 15px;
                font-size: 14px;
            }
            
            .main-content:not(.navbar .main-content) {
                max-width: calc(100% - 200px - 15px);
                padding-left: 10px;
            }
            
            .item-card {
                width: calc(50% - 10px);
                min-width: 280px;
                margin-bottom: 20px;
            }
            
            .item-card img {
                height: 180px;
            }
            
            .item-card h3 {
                font-size: 16px;
                margin: 8px 0;
            }
            
            .item-card p {
                font-size: 13px;
                margin: 4px 0;
            }
            
            .price {
                font-size: 16px !important;
                font-weight: bold;
            }
            
            #items-container {
                gap: 20px;
                justify-content: flex-start;
                margin-top: 120px;
            }
            
            .content-container {
                margin-top: 100px;
                padding: 15px;
            }
        }

        @media screen and (max-width: 1024px) {
             .search-filter-sidebar {
                width: 220px; /* Further reduced width */
             }
             .main-content:not(.navbar .main-content) {
                 max-width: calc(100% - 220px - 15px); /* Adjust max-width */
             }
        }

        @media screen and (max-width: 768px) {
            .content-container {
                flex-direction: column; /* Stack on smaller screens */
                align-items: center; /* Center items when stacked */
                padding: 10px;
                gap: 10px;
                margin-top: 100px; /* Adjust margin for navbar */
            }

            .search-filter-sidebar {
                width: 95%; /* Full width or near full width */
                max-width: 400px; /* Max width when stacked */
                margin-bottom: 20px; /* Space below sidebar */
                position: relative; /* Remove sticky */
                top: auto;
                max-height: none;
                overflow-y: visible;
            }

            .main-content:not(.navbar .main-content) {
                width: 100%; /* Allow main content to take full width */
                max-width: 100%;
                margin: 0 auto; /* Center main content container */
                padding: 0 10px; /* Add some padding */
            }

            #items-container {
               justify-content: center; /* Ensure items are centered within the now full-width container */
               gap: 15px; /* Adjust gap */
               padding-bottom: 80px;
            }
        }

        @media screen and (max-width: 576px) {
            .content-container {
                 padding: 5px;
                 gap: 5px;
                 margin-top: 90px;
            }
            .search-filter-sidebar {
                width: 98%;
                padding: 10px;
                margin-bottom: 15px;
            }
            .main-content:not(.navbar .main-content) {
                padding: 0 5px;
            }
            #items-container {
                gap: 10px;
                padding-bottom: 60px;
            }
        }

        .search-filter-sidebar h2 {
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .search-filter-sidebar label {
            display: block;
            font-size: 0.875rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .search-filter-sidebar input[type="text"] {
            width: calc(50% - 0.5rem);
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0;
            margin-bottom: 1rem;
            text-align: center;
            z-index: 2; /* Ensure inputs are clickable */
            pointer-events: auto; /* Ensure clicks are not blocked */
        }
        .search-filter-sidebar button {
            width: 100%;
            background-color: #069210;
            color: #ffffff;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 1rem;
            box-shadow: none;
            border: none;
            cursor: pointer;
            z-index: 2; /* Ensure button is clickable */
            pointer-events: auto; /* Ensure clicks are not blocked */
        }
/* New wrapper for custom select */
.custom-select-wrapper {
    position: relative;
    width: 100%;
    margin-bottom: 1rem; /* Inherit from original select */
}

/* Style the visible part of the custom select */
.select-styled {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0;
    background: #fff; /* Explicit background */
    text-align: center;
    cursor: pointer;
    height: 2.5rem; /* Match previous select height */
    line-height: 1.5rem; /* Match previous select line-height */
    box-sizing: border-box;
    display: flex; /* Use flex to center content */
    align-items: center; /* Vertically center content */
    justify-content: center; /* Horizontally center content */
    z-index: 2; /* Ensure custom select is clickable */
    pointer-events: auto; /* Ensure clicks are not blocked */
}

/* Hide the original select element but keep it functional */
.hidden-select {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0; /* Make it invisible */
    cursor: pointer; /* Keep cursor for native dropdown */
    z-index: 10; /* Ensure it's on top to capture native clicks */
    -webkit-appearance: none; /* For Safari/Chrome */
    -moz-appearance: none;    /* For Firefox */
    appearance: none;         /* Standard */
    border: none;             /* Remove border */
    background: transparent;  /* Remove background */
    text-align: center; /* Attempt to center text in dropdown options */
}

/* Adjust icon positioning within the new wrapper */
.custom-select-wrapper .fas.fa-chevron-down {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    pointer-events: none; /* Icon should not capture clicks */
    z-index: 11; /* Ensure icon is above the hidden select for visual purposes */
}
        
        .search-filter-sidebar .space-y-2 > div {
            display: flex;
            align-items: center;
        }
        .search-filter-sidebar .space-y-2 input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        /* Restore right panel (side panel) background if needed (from user's reference) */
        .sidebar {
            background-color: #fff;
        }

        /* Content container holding sidebar and main content area */
        .content-container {
            display: flex;
            gap: 20px;
            padding: 20px;
            margin-top: 120px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            align-items: flex-start; /* Align items to the top */
        }

        /* Main content area beside the sidebar */
        .main-content:not(.navbar .main-content) {
            flex-grow: 1;
            display: block;
            max-width: calc(1400px - 280px - 20px); /* Calculate max-width based on container and sidebar */
            margin: 0; /* Remove auto margin from here */
        }

        /* Item container (grid of item cards) */
        #items-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
            margin: 0 auto; /* Center item cards within the main content area */
            max-width: 100%; /* Ensure it fits within its parent */
            padding: 0;
            padding-bottom: 100px;
        }

        .item-card {
            background: #fff;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            width: 220px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            font-size: 0.9rem;
        }

        .item-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        /* Responsive Media Queries */
        @media screen and (max-width: 1200px) {
            #items-container {
                max-width: 1000px;
                gap: 15px;
            }
        }

        @media screen and (max-width: 992px) {
            #items-container {
                max-width: 800px;
                margin-top: 200px;
            }
        }

        @media screen and (max-width: 768px) {
            #items-container {
                max-width: 600px;
                margin-top: 180px;
                gap: 12px;
            }

            .item-card {
                width: 180px;
            }

            .item-card img {
                height: 130px;
            }
        }

        @media screen and (max-width: 576px) {
            #items-container {
                max-width: 100%;
                margin-top: 150px;
                gap: 10px;
                padding: 0 10px;
            }

            .item-card {
                width: 150px;
            }

            .item-card img {
                height: 120px;
            }
        }

        .item-card h3 {
            margin: 0;
            font-size: 1rem;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-shrink: 0;
            margin-bottom: 5px;
        }

        /* Container for Price and Time */
        .item-card .price-time {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .item-card .price {
            font-size: 1.1rem;
            font-weight: bold;
            color: #069210;
            flex-shrink: 0;
        }

        .item-card .time-ago {
            font-size: 0.7rem;
            color: gray;
            flex-shrink: 0;
        }

        /* Styling for the Condition element to look like a button */
        .item-card .condition {
            display: inline-block;
            background-color: #e0e0e0;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #333;
            margin-bottom: 5px;
            text-align: center;
            align-self: flex-start;
            flex-shrink: 0;
            border: 1px solid #ccc; /* Added border */
        }

        /* Container for Rating and Status */
        .item-card .rating-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .item-card .rating {
            font-size: 0.8rem;
            color: #555;
            flex-shrink: 0;
        }

        .item-card .status {
            font-size: 0.8rem;
            font-weight: bold;
            color: green;
            flex-shrink: 0;
        }

        /* Container for School Location */
        .item-card .school-location {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            color: #555;
            flex-shrink: 0;
            margin-top: auto;
        }

        .item-card .school-location i {
            margin-right: 4px;
            color: #069210;
        }

        /* Styles for the sliding conversation panel */
        #conversationPanel,
        #notificationPanel,
        #transactionPanel {
            position: fixed;
            top: 120px !important; /* Adjusted to start directly below the navbar */
            right: -480px !important; /* Ensure it's fully hidden when closed (increased from 420 to 480) */
            width: 480px !important; /* Increased width by 50% (320 -> 480) */
            height: calc(100vh - 120px) !important; /* Adjust height to fill space below navbar */
            background-color: #f9f9f9;
            box-shadow: -2px 0 8px rgba(0,0,0,0.4);
            transition: right 0.3s ease;
            z-index: 9998; /* Just below navbar */
            display: flex;
            flex-direction: column;
            border-radius: 8px 0 0 8px;
            margin: 0;
            bottom: 0;
            overflow-y: auto; /* Add scrolling if needed */
        }
        #conversationPanel.open,
        #notificationPanel.open,
        #transactionPanel.open {
            right: 0 !important; /* Ensure it opens to the right edge */
            box-shadow: -2px 0 8px rgba(0,0,0,0.4);
        }
        #conversationPanel iframe,
        #notificationPanel iframe,
        #transactionPanel iframe {
            border: none;
            width: 100%;
            height: 100%;
            flex-grow: 1;
            display: block;
        }
        #closeConversationPanel {
            background: #069210;
            color: white;
            border: none;
            border-radius: 0 0 0 8px;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 18px;
            align-self: flex-start;
        }
        #conversationOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: transparent; /* Removed darkening */
            z-index: 999; /* Below side panels */
            display: none;
        }

        #myConversationsBtn,
        #notificationsFloatBtn {
            background-color: #4FC3F7 !important;
            color: #fff !important;
        }

        #myConversationsBtn img,
        #notificationsFloatBtn img {
            filter: brightness(0) saturate(100%) invert(77%) sepia(16%) saturate(749%) hue-rotate(169deg) brightness(97%) contrast(92%);
        }

        /* Add or update this CSS to ensure icons are centered in their circle backgrounds */
        .topbar-action-icons button {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            background-color: #4FC3F7 !important;
            color: #fff !important;
            border: none !important;
            border-radius: 50% !important;
            width: 48px !important;
            height: 48px !important;
            font-size: 22px !important;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            padding: 0 !important;
        }
        .topbar-action-icons button i {
            color: #fff !important;
            font-size: 22px !important;
            margin: 0 !important;
            line-height: 1 !important;
        }
        :root {
  --items-container-margin-top: 0px; /* Adjust this value as needed */
}
        /* Item container (grid of item cards) from user's reference */
        #items-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
            margin: 0 auto;
            margin-top: 280px;
            max-width: 900px;
            padding-bottom: 100px;
            padding-left: 15px;
        }

        #pagination-controls {
            position: fixed;
            left: 50%;
            bottom: 0px;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            border-radius: 12px;
            padding: 12px 24px;
            display: flex;
            justify-content: center;

            align-items: center;
            gap: 10px;
        }

        /* Modal for Detailed Post */
        #detailedPostModal {
            display: none;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background-color: rgba(0,0,0,0.7);
            z-index: 10000 !important; /* Set a high z-index to appear above the navbar */
            justify-content: center;
            align-items: center;
            /* Removed inline styles from the div and put them here */
        }

        #detailedPostModal > div {
            position: relative;
            width: 90%;
            max-width: 900px;
            height: 90%;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            /* Removed inline styles from the inner div */
        }

        /* Close button for detailed post modal */
        #detailedPostModal #closeDetailedPostModal {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #069210;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 16px;
            cursor: pointer;
            z-index: 2100; /* Ensure close button is above modal content */
        }

        #detailedPostModal iframe {
            flex-grow: 1;
            border: none;
            border-radius: 0 0 10px 10px;
        }

.loader-spinner {
  border: 10px solid #e3f0fa;
  border-top: 10px solid #069210;
  border-radius: 50%;
  width: 70px;
  height: 70px;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg);}
  100% { transform: rotate(360deg);}
}

#imageZoomModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.85);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

/* Responsive Media Queries */
@media screen and (max-width: 1200px) {
  .content-container {
    flex-direction: column;
    align-items: center;
  }
  
  .search-filter-sidebar {
    width: 90%;
    max-width: 600px;
    margin-bottom: 20px;
  }
  
  #items-container {
    margin-top: 20px;
    padding-left: 0;
  }
}

@media screen and (max-width: 992px) {
  .navbar {
    padding: 10px;
    height: auto;
    min-height: 70px;
  }
  
  .main-content {
    width: 95%;
    padding-left: 0;
    gap: 10px;
  }
  
  .logo {
    height: 35px;
  }
  
  .search-bar {
    min-width: 150px;
  }
  
  .profile-section {
    left: 10px;
    top: 10px;
  }
  
  .notifications-container {
    right: 10px;
  }
  
  #items-container {
    margin-top: 200px;
    gap: 15px;
  }
}

@media screen and (max-width: 768px) {
  .navbar {
    padding: 8px;
    min-height: 60px;
  }
  
  .profile-section,
  .notifications-container {
    position: relative;
    left: 0;
    right: 0;
    top: 0;
    justify-content: center;
    margin-bottom: 5px;
    /* Ensure mobile view is horizontal */
    display: flex !important;
    flex-direction: row !important;
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .main-content {
    flex-direction: column;
    gap: 10px;
    padding-top: 40px;
  }
  
  .logo {
    height: 30px;
    margin-bottom: 5px;
  }
  
  .search-bar {
    width: 100%;
  }
  
  .topbar-action-icons {
    margin-top: 10px;
    margin-left: 0;
  }
  
  .topbar-action-icons button {
    width: 40px !important;
    height: 40px !important;
  }
  
  .item-card {
    width: 45%;
    min-width: 150px;
  }
  
  #items-container {
    margin-top: 180px;
    gap: 10px;
  }
  
  .content-container {
    margin-top: 150px;
  }
}

@media screen and (max-width: 576px) {
  .navbar {
    min-height: 50px;
  }
  
  .profile-section, .notifications-container {
    position: relative;
    left: 0;
    right: 0;
    top: 0;
    justify-content: center;
    margin-bottom: 5px;
    /* Ensure mobile view is horizontal */
    display: flex !important;
    flex-direction: row !important;
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .profile-section a,
  .notifications-container a {
    font-size: 0.75rem; /* Reduce font size for mobile */
    padding: 4px 8px; /* Adjust padding */
  }
  
  .main-content {
    position: relative;
    transform: none;
    left: 0;
    top: 0;
    width: 80%; /* Further reduce width in mobile view */
    padding: 0; /* Remove padding from here */
    margin: 0 auto; /* Center main content block */
  }
  
  .item-card {
    width: 100%;
  }
  
  #items-container {
    margin-top: 150px;
  }
  
  .search-filter-sidebar {
    width: 95%; /* Make sidebar shorter */
    margin: 0 auto; /* Center the shorter sidebar */
  }
  
  #conversationPanel,
  #notificationPanel,
  #transactionPanel {
    width: 100% !important;
    right: -100% !important;
  }
}

    /* Styles for the sliding conversation panel */
    #conversationPanel,
    #notificationPanel,
    #transactionPanel {
        position: fixed;
        top: 120px !important; /* Adjusted to start directly below the navbar */
        right: -480px !important; /* Ensure it's fully hidden when closed (increased from 420 to 480) */
        width: 480px !important; /* Increased width by 50% (320 -> 480) */
        height: calc(100vh - 120px) !important; /* Adjust height to fill space below navbar */
        background-color: #f9f9f9;
        box-shadow: -2px 0 8px rgba(0,0,0,0.4);
        transition: right 0.3s ease;
        z-index: 9998; /* Just below navbar */
        display: flex;
        flex-direction: column;
        border-radius: 8px 0 0 8px;
        margin: 0;
        bottom: 0;
        overflow-y: auto; /* Add scrolling if needed */
    }

    /* Hide the Post Item Modal Close button */
    #closePostItemModal {
        display: none;
    }

    #detailedPostModal iframe,
    #notificationPanel iframe,
    #transactionPanel iframe {
        border: none;
        width: 100%;
        height: 100%;
        flex-grow: 1;
        display: block;
    }

    #closeConversationPanel {
        background: #069210;
        color: white;
        border: none;
        border-radius: 0 0 0 8px;
        padding: 10px 15px;
        cursor: pointer;
        font-size: 18px;
        align-self: flex-start;
    }

    #conversationOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: transparent; /* Removed darkening */
        z-index: 999; /* Below side panels */
        display: none;
    }

    #myConversationsBtn,
    #notificationsFloatBtn {
        background-color: #4FC3F7 !important;
        color: #fff !important;
    }

    #myConversationsBtn img,
    #notificationsFloatBtn img {
        filter: brightness(0) saturate(100%) invert(77%) sepia(16%) saturate(749%) hue-rotate(169deg) brightness(97%) contrast(92%);
    }

    /* Add or update this CSS to ensure icons are centered in their circle backgrounds */
    .topbar-action-icons button {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        background-color: #4FC3F7 !important;
        color: #fff !important;
        border: none !important;
        border-radius: 50% !important;
        width: 48px !important;
        height: 48px !important;
        font-size: 22px !important;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        padding: 0 !important;
    }
    .topbar-action-icons button i {
        color: #fff !important;
        font-size: 22px !important;
        margin: 0 !important;
        line-height: 1 !important;
    }
    :root {
  --items-container-margin-top: 0px; /* Adjust this value as needed */
}
        /* Item container (grid of item cards) from user's reference */
        #items-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
            margin: 0 auto;
            margin-top: 280px;
            max-width: 900px;
            padding-bottom: 100px;
            padding-left: 15px;
        }

        #pagination-controls {
            position: fixed;
            left: 50%;
            bottom: 0px;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            border-radius: 12px;
            padding: 12px 24px;
            display: flex;
            justify-content: center;

            align-items: center;
            gap: 10px;
        }

        /* Modal for Detailed Post */
        #detailedPostModal {
            display: none;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background-color: rgba(0,0,0,0.7);
            z-index: 10000 !important; /* Set a high z-index to appear above the navbar */
            justify-content: center;
            align-items: center;
            /* Removed inline styles from the div and put them here */
        }

        #detailedPostModal > div {
            position: relative;
            width: 90%;
            max-width: 900px;
            height: 90%;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            /* Removed inline styles from the inner div */
        }

        /* Close button for detailed post modal */
        #detailedPostModal #closeDetailedPostModal {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #069210;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 16px;
            cursor: pointer;
            z-index: 2100; /* Ensure close button is above modal content */
        }

        #detailedPostModal iframe {
            flex-grow: 1;
            border: none;
            border-radius: 0 0 10px 10px;
        }

.loader-spinner {
  border: 10px solid #e3f0fa;
  border-top: 10px solid #069210;
  border-radius: 50%;
  width: 70px;
  height: 70px;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg);}
  100% { transform: rotate(360deg);}
}

#imageZoomModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.85);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

/* Responsive Media Queries */
@media screen and (max-width: 1200px) {
  .content-container {
    flex-direction: column;
    align-items: center;
  }
  
  .search-filter-sidebar {
    width: 90%;
    max-width: 600px;
    margin-bottom: 20px;
  }
  
  #items-container {
    margin-top: 20px;
    padding-left: 0;
  }
}

@media screen and (max-width: 992px) {
  .navbar {
    padding: 10px;
    height: auto;
    min-height: 70px;
  }
  
  .main-content {
    width: 95%;
    padding-left: 0;
    gap: 10px;
  }
  
  .logo {
    height: 35px;
  }
  
  .search-bar {
    min-width: 150px;
  }
  
  .profile-section {
    left: 10px;
    top: 10px;
  }
  
  .notifications-container {
    right: 10px;
  }
  
  #items-container {
    margin-top: 200px;
    gap: 15px;
  }
}

@media screen and (max-width: 768px) {
  .navbar {
    padding: 8px;
    min-height: 60px;
  }
  
  .profile-section,
  .notifications-container {
    position: relative;
    left: 0;
    right: 0;
    top: 0;
    justify-content: center;
    margin-bottom: 5px;
    /* Ensure mobile view is horizontal */
    display: flex !important;
    flex-direction: row !important;
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .main-content {
    flex-direction: column;
    gap: 10px;
    padding-top: 40px;
  }
  
  .logo {
    height: 30px;
    margin-bottom: 5px;
  }
  
  .search-bar {
    width: 100%;
  }
  
  .topbar-action-icons {
    margin-top: 10px;
    margin-left: 0;
  }
  
  .topbar-action-icons button {
    width: 40px !important;
    height: 40px !important;
  }
  
  .item-card {
    width: 45%;
    min-width: 150px;
  }
  
  #items-container {
    margin-top: 180px;
    gap: 10px;
  }
  
  .content-container {
    margin-top: 150px;
  }
}

@media screen and (max-width: 576px) {
  .navbar {
    min-height: 50px;
  }
  
  .profile-section, .notifications-container {
    position: relative;
    left: 0;
    right: 0;
    top: 0;
    justify-content: center;
    margin-bottom: 5px;
    /* Ensure mobile view is horizontal */
    display: flex !important;
    flex-direction: row !important;
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .profile-section a,
  .notifications-container a {
    font-size: 0.75rem; /* Reduce font size for mobile */
    padding: 4px 8px; /* Adjust padding */
  }
  
  .main-content {
    position: relative;
    transform: none;
    left: 0;
    top: 0;
    width: 80%; /* Further reduce width in mobile view */
    padding: 0; /* Remove padding from here */
    margin: 0 auto; /* Center main content block */
  }
  
  .item-card {
    width: 100%;
  }
  
  #items-container {
    margin-top: 150px;
  }
  
  .search-filter-sidebar {
    width: 95%; /* Make sidebar shorter */
    margin: 0 auto; /* Center the shorter sidebar */
  }
  
  #conversationPanel,
  #notificationPanel,
  #transactionPanel {
    width: 100% !important;
    right: -100% !important;
  }
}
    </style>

</head>
<body>
<script>
// Authentication check - runs immediately before any UI loads
(function() {
  const isLoggedIn = localStorage.getItem('isLoggedIn');
  const accessToken = localStorage.getItem('access_token');
  
  if (!isLoggedIn || isLoggedIn !== 'true' || !accessToken) {
    // User is not authenticated, redirect immediately
    window.location.href = 'Login_page.html';
    return;
  }
})();
</script>
 <div id="pageLoader" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:99999;background:transparent;display:flex;justify-content:center;align-items:center;">
  <div class="loader-spinner"></div>
</div>
    <div class="navbar">
      <!-- Profile Section (Left Side) -->
      <div class="profile-section" style="display: flex; align-items: center; gap: 8px;">
        <img src="Homepage_images/circle-user.png" alt="Profile" class="profile-icon">
        <span><a href="ViewProfile.html" class="link" style="background-color: #069210; padding: 6px 12px; border-radius: 4px; color: white; font-weight: 600; text-decoration: none; cursor: pointer;">Visit your profile</a></span>
        <span><a href="post_item.html" id="postItemLink" class="link" style="background-color: #069210; padding: 6px 12px; border-radius: 4px; color: white; font-weight: 600; text-decoration: none; cursor: pointer;">Post Item</a></span>
      </div>
  
      <!-- Notifications Container (Right Side - includes Logout) -->
      <div class="notifications-container" style="display: flex; gap: 20px; color: white;">
        <div class="nav-item">
          <img src="Homepage_images/bell.png" alt="Notifications" class="nav-icon" style="display:none;">
          <span style="display:none;">Notifications</span>
        </div>
        <div class="nav-item">
          <span><a href="#" class="logout" onclick="logoutUser()" style="background-color: #069210; padding: 6px 12px; border-radius: 4px; color: white; font-weight: 600; text-decoration: none; cursor: pointer;">Logout</a></span>
        </div>
      </div>
      <div class="main-content">
        <img src="Homepage_images/LOGO_WHITE.png" alt="CamFlea Logo" class="logo">
        <div class="search-bar" style="position: relative;">
          <input type="text" placeholder="Search" autocomplete="off" />
          <img src="Homepage_images/search.png" alt="Search" class="search-icon" />
          <div id="recent-searches-dropdown" style="display:none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
            <!-- Recent searches will be dynamically inserted here -->
          </div>
        </div>
        
        <div class="topbar-action-icons" style="display: flex; align-items: center; gap: 16px; margin-left: 16px;">
          <button id="transactionFloatBtn" title="Transactions" class="topbar-action-btn"><i class="fa-solid fa-credit-card"></i></button>
          <button id="notificationsFloatBtn" title="Notifications" class="topbar-action-btn" style="position: relative;">
            <i class="fa-solid fa-bell"></i>
            <span id="notificationBadge" style="display:none; position: absolute; top: -5px; right: -5px; background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; font-weight: bold; min-width: 20px; text-align: center; cursor: default;"></span>
          </button>
          <button id="myConversationsBtn" title="My Conversations" class="topbar-action-btn"><i class="fa-solid fa-comments"></i></button>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<!-- Image Zoom Modal -->
<div id="imageZoomModal" style="display:none; position:fixed; top:0; left: 0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); justify-content:center; align-items:center; z-index:9999;">
  <img id="zoomedImage" src="" style="max-width:90vw; max-height:90vh; border-radius:12px; box-shadow:0 4px 24px rgba(0,0,0,0.4);">
</div>
<script>
window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'zoomImage' && event.data.src) {
        console.log('Received zoomImage message in index.html:', event.data.src);
        const modal = document.getElementById('imageZoomModal');
        const img = document.getElementById('zoomedImage');
        img.src = event.data.src;
        modal.style.display = 'flex';
        // The modal CSS already centers content, no need to set styles here
        img.style.maxWidth = '90vw';
        img.style.maxHeight = '90vh';
        img.style.borderRadius = '12px';
        img.style.boxShadow = '0 4px 24px rgba(0,0,0,0.4)';
        img.style.position = 'relative';
        img.style.transform = 'none';
        img.style.top = 'auto';
        img.style.left = 'auto';
    }
});
document.getElementById('imageZoomModal').addEventListener('click', function(e) {
    if (e.target === this) {
        this.style.display = 'none';
        document.getElementById('zoomedImage').src = '';
    }
});
</script>
        <script>
          document.addEventListener("DOMContentLoaded", () => {
            const searchInput = document.querySelector(".search-bar input");
            const searchIcon = document.querySelector(".search-icon");
            const recentSearchesDropdown = document.getElementById("recent-searches-dropdown");

            // Restore search input value from localStorage if present
            const savedSearchQuery = localStorage.getItem("currentSearchQuery");
            if (savedSearchQuery) {
              searchInput.value = savedSearchQuery;
              // Apply search results based on restored search input
              fetchAndDisplayItems();
            }

            function getRecentSearches() {
              const studId = localStorage.getItem("stud_id") || "guest";
              const key = `recentSearches_${studId}`;
              const searches = localStorage.getItem(key);
              return searches ? JSON.parse(searches) : [];
            }

            function saveRecentSearch(searchTerm) {
              if (!searchTerm) return;
              const studId = localStorage.getItem("stud_id") || "guest";
              const key = `recentSearches_${studId}`;
              let searches = getRecentSearches();
              // Remove if already exists to avoid duplicates
              searches = searches.filter(term => term.toLowerCase() !== searchTerm.toLowerCase());
              searches.unshift(searchTerm);
              // Keep only last 5 searches
              if (searches.length > 5) {
                searches = searches.slice(0, 5);
              }
              localStorage.setItem(key, JSON.stringify(searches));
            }

            function renderRecentSearches() {
              const searches = getRecentSearches();
              if (searches.length === 0) {
                recentSearchesDropdown.style.display = "none";
                return;
              }
              recentSearchesDropdown.innerHTML = "";
              searches.forEach(term => {
                const item = document.createElement("div");
                item.style.display = "flex";
                item.style.justifyContent = "space-between";
                item.style.alignItems = "center";
                item.style.padding = "8px 12px";
                item.style.borderBottom = "1px solid #eee";

                const termSpan = document.createElement("span");
                termSpan.textContent = term;
                termSpan.style.cursor = "pointer";
                termSpan.style.flexGrow = "1";
                termSpan.addEventListener("click", () => {
                  searchInput.value = term;
                  localStorage.setItem("currentSearchQuery", term); // Persist selected recent search
                  recentSearchesDropdown.style.display = "none";
                  fetchAndDisplayItems();
                  searchInput.blur();
                });

                const deleteBtn = document.createElement("button");
                deleteBtn.textContent = "Ã—";
                deleteBtn.style.background = "transparent";
                deleteBtn.style.border = "none";
                deleteBtn.style.color = "#888";
                deleteBtn.style.fontSize = "16px";
                deleteBtn.style.cursor = "pointer";
                deleteBtn.style.marginLeft = "10px";
                deleteBtn.title = "Delete this search";
                deleteBtn.addEventListener("click", (e) => {
                  e.stopPropagation();
                  e.preventDefault();
                  let updatedSearches = getRecentSearches().filter(s => s.toLowerCase() !== term.toLowerCase());
                  const studId = localStorage.getItem("stud_id") || "guest";
                  const key = `recentSearches_${studId}`;
                  localStorage.setItem(key, JSON.stringify(updatedSearches));
                  renderRecentSearches();
                });

                item.appendChild(termSpan);
                item.appendChild(deleteBtn);
                recentSearchesDropdown.appendChild(item);
              });
              recentSearchesDropdown.style.display = "block";
            }

            searchInput.addEventListener("click", function () {
              if (this.value.length > 0) {
                this.select();
              }
              renderRecentSearches();
            });

            searchInput.addEventListener("blur", function () {
              // Delay hiding dropdown to allow click event on dropdown items
              setTimeout(() => {
                recentSearchesDropdown.style.display = "none";
              }, 200);
            });

searchInput.addEventListener("input", function () {
  if (searchInput.value.trim() === "") {
    fetchAndDisplayItems();
    localStorage.removeItem("currentSearchQuery");
  } else {
    // When user clears and starts typing, update currentSearchQuery in localStorage
    localStorage.setItem("currentSearchQuery", searchInput.value.trim());
    // Do not fetch results while typing to avoid excessive queries
    // fetchAndDisplayItems();
  }
});

            searchInput.addEventListener("keypress", function (event) {
              if (event.key === "Enter") {
                if (searchInput.value.trim() === "") {
                  fetchAndDisplayItems();
                  localStorage.removeItem("currentSearchQuery");
                } else {
                  fetchAndDisplayItems();
                  saveRecentSearch(searchInput.value.trim());
                  localStorage.setItem("currentSearchQuery", searchInput.value.trim());
                }
                // Remove focus from search input to hide insertion point
                searchInput.blur();
              }
            });

            searchIcon.addEventListener("click", function () {
              if (searchInput.value.trim() === "") {
                fetchAndDisplayItems();
                localStorage.removeItem("currentSearchQuery");
              } else {
                fetchAndDisplayItems();
                saveRecentSearch(searchInput.value.trim());
                localStorage.setItem("currentSearchQuery", searchInput.value.trim());
              }
            });

            // Debounce helper function
            function debounce(func, wait) {
              let timeout;
              return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
              };
            }

            // Removed debounced input event listener to disable auto-search on typing
            // const debouncedSearch = debounce(() => {
            //   if (searchInput.value.trim() === "") {
            //     fetchAndDisplayItems();
            //     localStorage.removeItem("currentSearchQuery");
            //   } else {
            //     fetchAndDisplayItems();
            //     localStorage.setItem("currentSearchQuery", searchInput.value.trim());
            //   }
            // }, 300);

            // searchInput.removeEventListener("input", debouncedSearch);

            // Do NOT render recent searches dropdown on page load to avoid auto dropdown after login
            // renderRecentSearches();

            // Custom Select Dropdown Logic
            const customSelects = [
              { id: 'rating-filter', styledId: 'rating-filter-styled' },
              { id: 'sort-filter', styledId: 'sort-filter-styled' },
              { id: 'school-filter', styledId: 'school-filter-styled' },
              { id: 'condition-filter', styledId: 'condition-filter-styled' }
            ];

            customSelects.forEach(selectData => {
              const selectElement = document.getElementById(selectData.id);
              const styledElement = document.getElementById(selectData.styledId);

              if (selectElement && styledElement) {
                // Set initial text for styled div
                styledElement.textContent = selectElement.options[selectElement.selectedIndex].textContent;

                // Update styled div text when select value changes
                selectElement.addEventListener('change', () => {
                  styledElement.textContent = selectElement.options[selectElement.selectedIndex].textContent;
                  fetchAndDisplayItems(); // Re-trigger fetch on change
                });

                // When styled div is clicked, open the native select
                styledElement.addEventListener('click', () => {
                  selectElement.focus();
                  selectElement.click(); // Programmatically open the dropdown
                });
              }
            });
          });

          // Unified function to fetch and display items based on search query and filters
async function fetchAndDisplayItems() {
  const loader = document.getElementById('pageLoader');
  if (loader) loader.style.display = 'flex';

  try {
    const searchQuery = document.querySelector(".search-bar input").value.trim();

    // Get current filter values
    const condition = document.getElementById('condition-filter').value;
    const school = document.getElementById('school-filter').value;
    let priceMin = parseFloat(document.getElementById('price-min').value);
    let priceMax = parseFloat(document.getElementById('price-max').value);

    // Fix: When both min and max are empty, treat as no price filter (show all items)
    const minInputRaw = document.getElementById('price-min').value.trim();
    const maxInputRaw = document.getElementById('price-max').value.trim();

    // New fix: If both inputs are empty, do not apply price filter
    if (minInputRaw === '' && maxInputRaw === '') {
      priceMin = null;
      priceMax = null;
    } else {
      if (isNaN(priceMin)) priceMin = 0;
      if (isNaN(priceMax)) priceMax = Number.MAX_VALUE;
    }

    // **Add this check**
    if (priceMin !== null && priceMax !== null && priceMin > priceMax) {
      const container = document.getElementById("items-container");
      container.innerHTML = "<p>No items found matching your search and filters.</p>";
      if (loader) loader.style.display = 'none'; // Hide loader before return
      return;
    }
    if (priceMin === null) {
      priceMin = 0;
    }
    if (priceMax === null) {
      priceMax = Number.MAX_VALUE;
    }

    // Map checkbox IDs to enum values
    const itemTypeMap = {
      'type-books': 'books & school supplies',
      'type-clothes': 'clothes & accessories',
      'type-gadgets': 'gadgets & electronics',
      'type-instruments': 'instruments & recreations',
      'type-crafted': 'crafted & collectibles',
      'type-sports': 'sports & fitness',
    };

    // Get selected item types from the checkboxes
    const itemTypes = Array.from(document.querySelectorAll('.item-type-checkbox:checked'))
      .map(checkbox => itemTypeMap[checkbox.id]); // Map IDs to enum values

    // If school filter is set, first query student IDs for that school
    let studentIds = null;
    if (school && school !== '') {
      const { data: students, error: studentError } = await supabaseClient
        .from('student')
        .select('stud_id')
        .eq('stud_school', school);

      if (studentError) {
        console.error('Error fetching students for school filter:', studentError);
        if (loader) loader.style.display = 'none'; // Hide loader before return
        return;
      }

      studentIds = students.map(s => s.stud_id);
      if (studentIds.length === 0) {
        // No students found for this school, so no items to show
        const container = document.getElementById("items-container");
        container.innerHTML = "<p>No items found matching your filters.</p>";
        if (loader) loader.style.display = 'none'; // Hide loader before return
        return;
      }
    }

    let query = supabaseClient
      .from("item")
      .select(
        `
            item_id,
            item_name,
            item_description,
            item_condition,
            item_status,
            item_type,
            item_price_type,
            item_price_min,
            item_price_max,
            item_price,
            photos,
            created_at,
            stud_id,
            student:stud_id (
                stud_school
            )
        `
      )
      .in("item_status", ["available", "reserved"]);

    // Determine if price filter is active
    const minInput = document.getElementById('price-min').value.trim();
    const maxInput = document.getElementById('price-max').value.trim();

    if (minInput !== '' || maxInput !== '') {
      // At least one price filter is active
      let priceMin = minInput === '' ? 0 : parseFloat(minInput);
      let priceMax = maxInput === '' ? Number.MAX_VALUE : parseFloat(maxInput);

      if (!isNaN(priceMin) && !isNaN(priceMax)) {
        let priceFilter = `and(item_price_type.eq.single,item_price.gte.${priceMin},item_price.lte.${priceMax}),and(item_price_type.eq.range,item_price_min.lte.${priceMax},item_price_max.gte.${priceMin})`;
        query = query.or(priceFilter);
      }
    }
    // If both are empty, do not apply any price filter at all

    if (condition) {
      query = query.eq('item_condition', condition);
    }

    if (studentIds) {
      query = query.in('stud_id', studentIds);
    }

    if (itemTypes.length > 0) {
      query = query.in('item_type', itemTypes);
    }

    const { data, error } = await query;

    if (error) {
      console.error("Error fetching items:", error);
      if (loader) loader.style.display = 'none'; // Hide loader before return
      return;
    }

    let filteredData = data;

    // Client-side filter to exclude items with missing student or stud_school
    filteredData = filteredData.filter(item => item.student && item.student.stud_school);

    // Seller's rating filter
    const ratingFilter = document.getElementById("rating-filter");
    let minRating = 0;
    let maxRating = 5.01; // default: show all

    if (ratingFilter && ratingFilter.value) {
      const selected = parseInt(ratingFilter.value, 10);
      switch (selected) {
        case 1:
          minRating = 0;
          maxRating = 2;
          break;
        case 2:
          minRating = 2;
          maxRating = 3;
          break;
        case 3:
          minRating = 3;
          maxRating = 4;
          break;
        case 4:
          minRating = 4;
          maxRating = 5;
          break;
        case 5:
          minRating = 5;
          maxRating = 5.01; // Only exactly 5.0
          break;
        default:
          minRating = 0;
          maxRating = 5.01;
      }
    }

    if (ratingFilter && ratingFilter.value) {
      const sellerRatings = await fetchSellerRatings();
      filteredData = filteredData.filter(item => {
        const sellerId = item.stud_id;
        const ratingObj = sellerRatings[sellerId] || { avg: 0 };
        return ratingObj.avg >= minRating && ratingObj.avg < maxRating;
      });
    }

    const container = document.getElementById("items-container");
    container.innerHTML = "";

    if (filteredData.length === 0) {
      container.innerHTML = "<p>No items found matching your filters.</p>";
      if (loader) loader.style.display = 'none'; // Hide loader before return
      return;
    }

    // --- Sorting ---
    const sortFilter = document.getElementById("sort-filter");
    const sellerRatings = await fetchSellerRatings(); // Already fetched for rating filter

    if (sortFilter && sortFilter.value) {
      switch (sortFilter.value) {
        case "newest":
          filteredData.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          break;
case "price-low-high":
  // Exclude items with hidden price
  filteredData = filteredData.filter(item =>
    item.item_price_type === "single" || item.item_price_type === "range"
  );
  filteredData.sort((a, b) => {
    const getPrice = item =>
      item.item_price_type === "single"
        ? item.item_price
        : item.item_price_type === "range"
        ? item.item_price_min
        : Number.MAX_VALUE;
    return getPrice(a) - getPrice(b);
  });
  break;
case "price-high-low":
  // Exclude items with hidden price
  filteredData = filteredData.filter(item =>
    item.item_price_type === "single" || item.item_price_type === "range"
  );
  filteredData.sort((a, b) => {
    const getPrice = item =>
      item.item_price_type === "single"
        ? item.item_price
        : item.item_price_type === "range"
        ? item.item_price_max
        : 0;
    return getPrice(b) - getPrice(a);
  });
  break;
        case "rating-high-low":
          filteredData.sort((a, b) => {
            const ratingA = sellerRatings[a.stud_id]?.avg || 0;
            const ratingB = sellerRatings[b.stud_id]?.avg || 0;
            return ratingB - ratingA;
          });
          break;
        case "condition":
          // Order: brand new (best), gently used, heavily used (worst)
          const conditionOrder = { "brand new": 0, "gently used": 1, "heavily used": 2 };
          filteredData.sort((a, b) => {
            return (conditionOrder[a.item_condition] ?? 99) - (conditionOrder[b.item_condition] ?? 99);
          });
          break;
        default:
          // Default to newest
          filteredData.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      }
    }

    // If search query is empty, display all filtered items without fuzzy search
    if (!searchQuery) {
      displayItems(filteredData, container);
      if (loader) loader.style.display = 'none'; // Hide loader after displayItems
      return;
    }

    // Setup Fuse.js for fuzzy search on filtered data
    const options = {
      keys: [
        { name: "item_name", weight: 0.9 },
        { name: "item_description", weight: 0.1 }
      ],
      threshold: 0.5, // Increased threshold for better recall
      includeMatches: true,
      minMatchCharLength: 2, // Lowered minMatchCharLength to allow shorter matches
      ignoreLocation: false,
    };
    const fuse = new Fuse(filteredData, options);
    let result = fuse.search(searchQuery);

    // Boost scores for exact word matches
    const queryLower = searchQuery.toLowerCase();
    result.forEach(r => {
      const itemName = r.item.item_name.toLowerCase();
      const itemDesc = (r.item.item_description || "").toLowerCase();
      const exactWordRegex = new RegExp(`\\b${queryLower}\\b`, 'i');
      if (exactWordRegex.test(itemName) || exactWordRegex.test(itemDesc)) {
        // Boost score by reducing it (better score)
        r.score = r.score * 0.1; // More aggressive boost for exact matches
      }
    });

    // Sort results by adjusted score ascending
    result.sort((a, b) => a.score - b.score);

    // Filter results by score to exclude low similarity matches
    // result = result.filter(r => r.score !== undefined && r.score <= 0.4);

    if (result.length === 0) {
      container.innerHTML = "<p>No items found matching your search and filters.</p>";
      if (loader) loader.style.display = 'none'; // Hide loader before return
      return;
    }

    // Extract items from Fuse result
    const searchedItems = result.map(r => {
      return {
        item: r.item,
        matches: r.matches
      };
    });

    displayItems(searchedItems, container, true);
  } finally {
    if (loader) loader.style.display = 'none';
  }
}

          // Helper function to display items in container
          let currentPage = 1;
          const itemsPerPage = 15; // 5 layers * 3 items per layer

async function fetchSellerRatings() {
  // Get average stars and count for each seller
  const { data, error } = await supabaseClient
    .from('feedback')
    .select('seller_id, stars');
  if (error) {
    console.error('Error fetching feedback:', error);
    return {};
  }
  // Aggregate by seller_id
  const ratings = {};
  data.forEach(fb => {
    if (!ratings[fb.seller_id]) {
      ratings[fb.seller_id] = { total: 0, count: 0 };
    }
    ratings[fb.seller_id].total += fb.stars;
    ratings[fb.seller_id].count += 1;
  });
  // Compute average
  Object.keys(ratings).forEach(sellerId => {
    ratings[sellerId].avg = ratings[sellerId].count > 0
      ? ratings[sellerId].total / ratings[sellerId].count
      : 0;
  });
  return ratings;
}

// Now proceed with displayItems function modified to use ratings
async function displayItems(items, container, withHighlight = false, page = 1) {
  const sellerRatings = await fetchSellerRatings();

  function timeAgo(createdAt) {
    const createdDateUtc = new Date(createdAt);
    const now = new Date();
    const diffInSeconds = Math.floor((now - createdDateUtc) / 1000);

    if (diffInSeconds < 60)
      return `${diffInSeconds} sec${diffInSeconds === 1 ? "" : "s"} ago`;
    const diffInMinutes = Math.floor(diffInSeconds / 60);
    if (diffInMinutes < 60)
      return `${diffInMinutes} min${diffInMinutes === 1 ? "" : "s"} ago`;
    const diffInHours = Math.floor(diffInMinutes / 60);
    if (diffInHours < 24)
      return `${diffInHours} hr${diffInHours === 1 ? "" : "s"} ago`;
    const diffInDays = Math.floor(diffInHours / 24);
    return `${diffInDays} day${diffInDays === 1 ? "" : "s"} ago`;
  }

  // Helper function to highlight matched substrings
  function highlightMatches(text, indices) {
    if (!indices || indices.length === 0) return text;
    let result = "";
    let lastIndex = 0;
    indices.forEach(([start, end]) => {
      result += text.substring(lastIndex, start);
      result += `<span style="background-color: yellow;">${text.substring(start, end + 1)}</span>`;
      lastIndex = end + 1;
    });
    result += text.substring(lastIndex);
    return result;
  }

  // Sort items by relevance score ascending to show most accurate first
  items.sort((a, b) => {
    const scoreA = withHighlight ? a.score ?? 0 : 0;
    const scoreB = withHighlight ? b.score ?? 0 : 0;
    return scoreA - scoreB;
  });

  // Calculate pagination
  const totalItems = items.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  if (page < 1) page = 1;
  if (page > totalPages) page = totalPages;

  const startIndex = (page - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
  const itemsToDisplay = items.slice(startIndex, endIndex);

  container.innerHTML = ''; // Clear container before adding cards

  itemsToDisplay.forEach(entry => {
    const item = withHighlight ? entry.item : entry;
    const matches = withHighlight ? entry.matches : null;

    const photoUrl = item.photos?.[0] || "https://via.placeholder.com/250x200?text=No+Image";
    const school = item.student?.stud_school || "No School Found";
    const timePosted = timeAgo(item.created_at);

    // Prepare highlighted fields
    let highlightedName = item.item_name;
    let highlightedDescription = item.item_description || "";
    let highlightedCondition = item.item_condition;
    let highlightedType = item.item_type;
    let highlightedSchool = school;

    if (withHighlight && matches && matches.length > 0) {
      matches.forEach(match => {
        const key = match.key;
        const indices = match.indices;
        if (key === "item_name") {
          highlightedName = highlightMatches(item.item_name, indices);
        } else if (key === "item_description") {
          highlightedDescription = highlightMatches(item.item_description || "", indices);
        } else if (key === "item_condition") {
          highlightedCondition = highlightMatches(item.item_condition, indices);
        } else if (key === "item_type") {
          highlightedType = highlightMatches(item.item_type, indices);
        } else if (key === "student.stud_school") {
          highlightedSchool = highlightMatches(school, indices);
        }
      });
    }

    const card = document.createElement("div");
    card.className = "item-card"; // Add item-card class

    card.onclick = () => {
      if (!item.item_id) {
        console.error("Item ID is undefined for this item:", item);
        alert("Failed to load item details. Please try again.");
        return;
      }
      // Open modal and load detailed post in iframe
      const modal = document.getElementById('detailedPostModal');
      const iframe = document.getElementById('detailedPostIframe');
      iframe.src = `Detailed_post.html?item_id=${item.item_id}&embedded=1`;
      modal.style.display = 'flex';
    };

    let priceDisplay = '';
    if (item.item_price_type === 'single') {
      priceDisplay = `PHP${formatPrice(item.item_price)}`;
    } else if (item.item_price_type === 'range') {
      priceDisplay = `PHP${formatPrice(item.item_price_min)} - PHP${formatPrice(item.item_price_max)}`;
    } else if (item.item_price_type === 'hidden') {
      priceDisplay = 'Price hidden';
    } else {
      priceDisplay = 'Price not available';
    }

    // Get seller rating
    const sellerId = item.stud_id;
    const ratingObj = sellerRatings[sellerId] || { avg: 0, count: 0 };
    const avgRating = ratingObj.avg;

    // Function to generate star icons based on average rating
    function generateStarIcons(rating) {
      let starsToShow = 1;
      if (rating >= 5) {
        starsToShow = 5;
      } else if (rating >= 4) {
        starsToShow = 4;
      } else if (rating >= 3) {
        starsToShow = 3;
      } else if (rating >= 2) {
        starsToShow = 2;
      } else if (rating >= 0) {
        starsToShow = 1;
      }
      let starHtml = '';
      for (let i = 0; i < starsToShow; i++) {
        starHtml += '<i class="fas fa-star" style="color: #FFD700; margin-right: 2px;"></i>';
      }
      return starHtml;
    }

const starIcons = generateStarIcons(avgRating);
const avgRatingDisplay = avgRating ? avgRating.toFixed(1) : '0.0';
const ratingDisplay = `${starIcons} ${avgRatingDisplay} (${ratingObj.count})`;

    // Construct the inner HTML based on the image layout
    card.innerHTML = `
      <img src="${photoUrl}" alt="${item.item_name}">
      <h3>${highlightedName}</h3>
      <div class="price-time">
          <span class="price">${priceDisplay}</span>
          <span class="time-ago">${timePosted}</span>
      </div>
      <div class="condition">${highlightedCondition}</div>
      <div class="rating-status">
          <span class="rating">${ratingDisplay}</span>
          <span class="status" style="color: ${item.item_status === 'available' ? 'green' : item.item_status === 'reserved' ? 'orange' : 'gray'}; font-weight: bold;">
            ${item.item_status.charAt(0).toUpperCase() + item.item_status.slice(1)}
          </span>
      </div>
      <div class="school-location">
          <i class="fas fa-map-marker-alt"></i>
          <span>${highlightedSchool}</span>
      </div>
    `;

    container.appendChild(card);
  });

  // Pagination controls
  let paginationContainer = document.getElementById('pagination-controls');
  if (!paginationContainer) {
    paginationContainer = document.createElement('div');
    paginationContainer.id = 'pagination-controls';
    paginationContainer.style.display = 'flex';
    paginationContainer.style.justifyContent = 'center';
    paginationContainer.style.alignItems = 'center';
    paginationContainer.style.marginTop = '20px';
    paginationContainer.style.gap = '10px';

    container.parentNode.appendChild(paginationContainer);
  }

  paginationContainer.innerHTML = '';

  const prevButton = document.createElement('button');
  prevButton.textContent = 'â† Previous';
  prevButton.style.padding = '8px 0px';
  prevButton.style.backgroundColor = '#069210';
  prevButton.style.color = 'white';
  prevButton.style.border = 'none';
  prevButton.style.borderRadius = '5px';
  prevButton.style.cursor = 'pointer';
  prevButton.style.width = '100px';
  prevButton.style.boxSizing = 'border-box';
  prevButton.disabled = page === 1;
  prevButton.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      displayItems(items, container, withHighlight, currentPage);
      // Reset scroll to top on page change
      container.scrollTop = 0;
    }
  });

  const pageIndicator = document.createElement('span');
  pageIndicator.textContent = `Page ${page} of ${totalPages}`;
  pageIndicator.style.fontWeight = 'bold';
  pageIndicator.style.minWidth = '120px';  /* Added wider space for page indicator */
  pageIndicator.style.textAlign = 'center';

  const nextButton = document.createElement('button');
  nextButton.textContent = 'Next â†’';
  nextButton.style.padding = '8px 0px';
  nextButton.style.backgroundColor = '#069210';
  nextButton.style.color = 'white';
  nextButton.style.border = 'none';
  nextButton.style.borderRadius = '5px';
  nextButton.style.cursor = 'pointer';
  nextButton.style.width = '100px';
  nextButton.style.boxSizing = 'border-box';
  nextButton.disabled = page === totalPages;
  nextButton.addEventListener('click', () => {
    if (currentPage < totalPages) {
      currentPage++;
      displayItems(items, container, withHighlight, currentPage);
      // Reset scroll to top on page change
      container.scrollTop = 0;
    }
  });

  paginationContainer.appendChild(prevButton);
  paginationContainer.appendChild(pageIndicator);
  paginationContainer.appendChild(nextButton);
}
        </script>
        <div class="ask-ai-container" id="ask-ai-container" style="cursor: pointer;">
          <img src="Homepage_images/ai.png" alt="Ask AI" class="ask-ai-icon" style="display:none;">
          <span class="ask-ai" style="display:none;"><a href="#" class="link" id="ask-ai-link">Ask AI</a></span>
        </div>
      </div>
    </div>
  
    <!-- Overlay -->
    <!-- Removed overlay element to allow interaction with other UI elements -->

    <!-- Sliding conversation panel with iframe -->
    <div id="conversationPanel" aria-hidden="true" style="position: fixed; top: 0; width: 420px; height: 100%; background-color: #f9f9f9; box-shadow: -2px 0 8px rgba(0,0,0,0.4); transition: right 0.3s ease; z-index: 1000; display: flex; flex-direction: column;">
    <!-- Removed close button as per user request -->
    <iframe src="myconversation.html" title="My Conversations" style="border: none; width: 100%; height: 100%; flex-grow: 1;"></iframe>
    </div>

    <!-- Sliding notification panel with iframe -->
    <div id="notificationPanel" aria-hidden="true" style="position: fixed; top: 0; width: 420px; height: 100%; background-color: #f9f9f9; box-shadow: -2px 0 8px rgba(0,0,0,0.4); transition: right 0.3s ease; z-index: 1000; display: flex; flex-direction: column;">
      <iframe src="notification.html" title="Notifications" style="border: none; width: 100%; height: 100%; flex-grow: 1;"></iframe>
    </div>

    <!-- Sliding transaction panel with iframe -->
<div id="transactionPanel" aria-hidden="true" style="position: fixed; top: 0; width: 420px; height: 100%; background-color: #f9f9f9; box-shadow: -2px 0 8px rgba(0,0,0,0.4); transition: right 0.3s ease; z-index: 1000; display: flex; flex-direction: column;">
      <iframe src="transaction.html" title="Transactions" style="border: none; width: 100%; height: 100%; flex-grow: 1;"></iframe>
    </div>
      
        <!-- CONTENT WRAPPER -->
        <div class="content-container">
          <div class="search-filter-sidebar">
            <h2>SEARCH FILTER</h2>
      
            <div class="mb-4">
              <label>Price Range</label>
              <div class="flex space-x-2" style="position: relative; z-index: 2;">
                <input id="price-min" type="text" placeholder="MIN" class="w-1/2 p-2 border border-gray-300">
                <input id="price-max" type="text" placeholder="MAX" class="w-1/2 p-2 border border-gray-300">
              </div>
              <button id="apply-price-filter" type="button" style="width: 100%; margin-top: 8px; background-color: #069210; color: white; padding: 0.5rem; border-radius: 0.375rem; font-size: 1rem; font-weight: 500; border: none; cursor: pointer; position: relative; z-index: 2;">Apply</button>
            </div>
      
            <div class="mb-4">
              <label>Seller's Rating</label>
              <div class="custom-select-wrapper">
                <div class="select-styled" id="rating-filter-styled"></div>
                <i class="fas fa-chevron-down"></i>
                <select id="rating-filter" class="hidden-select">
                  <option value="">All Ratings</option>
                  <option value="5">5 stars</option>
                  <option value="4">4 stars</option>
                  <option value="3">3 stars</option>
                  <option value="2">2 stars</option>
                  <option value="1">1 star</option>
                </select>
              </div>
            </div>

            <div class="mb-4">
              <label for="sort-filter">Sort By</label>
              <div class="custom-select-wrapper">
                <div class="select-styled" id="sort-filter-styled"></div>
                <i class="fas fa-chevron-down"></i>
                <select id="sort-filter" class="hidden-select">
                  <option value="newest">Newest First</option>
                  <option value="price-low-high">Price: Low to High</option>
                  <option value="price-high-low">Price: High to Low</option>
                  <option value="rating-high-low">Seller Rating: High to Low</option>
                  <option value="condition">Condition: Best First</option>
                </select>
                <i class="fas fa-chevron-down"></i>
              </div>
            </div>
      
            <div class="mb-4">
              <label>School From</label>
              <div class="custom-select-wrapper">
                <div class="select-styled" id="school-filter-styled"></div>
                <i class="fas fa-chevron-down"></i>
                <select id="school-filter" class="hidden-select">
                  <option value="">All Schools</option>
                  <option value="Gordon College">Gordon College</option>
                  <option value="Columban College">Columban College</option>
                </select>
              </div>
            </div>
              <script>
              // Persist and restore search input and filter selections including school filter
              document.addEventListener("DOMContentLoaded", () => {
                const userSchool = localStorage.getItem("userSchool");
                const searchInput = document.querySelector(".search-bar input");
                const schoolFilter = document.getElementById("school-filter");
                const schoolFilterStyled = document.getElementById("school-filter-styled");
                const conditionFilter = document.getElementById("condition-filter");
                const priceMinInput = document.getElementById("price-min");
                const priceMaxInput = document.getElementById("price-max");
                const itemTypeCheckboxes = document.querySelectorAll(".item-type-checkbox");
      
                // Restore search input value from localStorage if present
                const savedSearchQuery = localStorage.getItem("currentSearchQuery");
                if (savedSearchQuery) {
                  searchInput.value = savedSearchQuery;
                }
      
                // Restore saved filters from localStorage or use defaults
                const savedSchool = localStorage.getItem("filter_school");
                const savedCondition = localStorage.getItem("filter_condition");
                const savedPriceMin = localStorage.getItem("filter_price_min");
                const savedPriceMax = localStorage.getItem("filter_price_max");
                const savedItemTypes = JSON.parse(localStorage.getItem("filter_item_types") || "[]");
      
                if (savedSchool !== null) {
                  schoolFilter.value = savedSchool;
                } else if (userSchool && (userSchool === "Gordon College" || userSchool === "Columban College")) {
                  schoolFilter.value = userSchool;
                } else {
                  schoolFilter.value = ""; // default to All Schools if no match
                }
                // Update the styled div text to match the selected school filter option
                if (schoolFilterStyled) {
                  const selectedOption = schoolFilter.options[schoolFilter.selectedIndex];
                  schoolFilterStyled.textContent = selectedOption ? selectedOption.textContent : "All Schools";
                }
      
                if (savedCondition) {
                  conditionFilter.value = savedCondition;
                } else {
                  conditionFilter.value = "";
                }
      
                if (savedPriceMin) {
                  priceMinInput.value = savedPriceMin;
                } else {
                  priceMinInput.value = "";
                }
      
                if (savedPriceMax) {
                  priceMaxInput.value = savedPriceMax;
                } else {
                  priceMaxInput.value = "";
                }
      
                if (savedItemTypes.length > 0) {
                  itemTypeCheckboxes.forEach(checkbox => {
                    checkbox.checked = savedItemTypes.includes(checkbox.id);
                  });
                } else {
                  itemTypeCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                  });
                }
      
              // Save filter changes to localStorage
              schoolFilter.addEventListener("change", () => {
                localStorage.setItem("filter_school", schoolFilter.value);
                fetchAndDisplayItems();
              });
      
              conditionFilter.addEventListener("change", () => {
                localStorage.setItem("filter_condition", conditionFilter.value);
                fetchAndDisplayItems();
              });
      
            priceMinInput.addEventListener("input", () => {
              localStorage.setItem("filter_price_min", priceMinInput.value);
              // fetchAndDisplayItems(); // Disabled to prevent filtering on input, only on Apply button click
            });
      
            priceMaxInput.addEventListener("input", () => {
              localStorage.setItem("filter_price_max", priceMaxInput.value);
              // fetchAndDisplayItems(); // Disabled to prevent filtering on input, only on Apply button click
            });
      
            function checkAndResetPriceFilter() {
              if (priceMinInput.value.trim() === '' && priceMaxInput.value.trim() === '') {
                fetchAndDisplayItems();
              }
            }
      
            priceMinInput.addEventListener('input', checkAndResetPriceFilter);
            priceMaxInput.addEventListener('input', checkAndResetPriceFilter);

              // Add event listener for rating filter
              const ratingFilter = document.getElementById("rating-filter");
              if (ratingFilter) {
                ratingFilter.addEventListener("change", fetchAndDisplayItems);
              }

              // Add event listener for sort filter
              const sortFilter = document.getElementById("sort-filter");
              if (sortFilter) {
                sortFilter.addEventListener("change", fetchAndDisplayItems);
              }
      
              itemTypeCheckboxes.forEach(checkbox => {
                checkbox.addEventListener("change", () => {
                  const selectedTypes = Array.from(itemTypeCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.id);
                  localStorage.setItem("filter_item_types", JSON.stringify(selectedTypes));
                  fetchAndDisplayItems();
                });
              });
      
              // Initial fetch with restored search and filters
              fetchAndDisplayItems();
            });
            </script>
      
            <div class="mb-4">
              <label>Condition</label>
              <div class="custom-select-wrapper">
                <div class="select-styled" id="condition-filter-styled"></div>
                <i class="fas fa-chevron-down"></i>
                <select id="condition-filter" class="hidden-select">
                  <option value="">All Conditions</option>
                  <option value="brand new">Brand New</option>
                  <option value="gently used">Gently Used</option>
                  <option value="heavily used">Heavily Used</option>
                </select>
              </div>
            </div>
      
            <div class="mb-4">
              <label>Item Type</label>
              <div class="space-y-2">
                <div><input type="checkbox" id="type-books" class="item-type-checkbox"><label for="type-books">Books & School Supplies</label></div>
                <div><input type="checkbox" id="type-clothes" class="item-type-checkbox"><label for="type-clothes">Clothes, Accessories & Self Care</label></div>
                <div><input type="checkbox" id="type-gadgets" class="item-type-checkbox"><label for="type-gadgets">Gadgets & Electronics</label></div>
                <div><input type="checkbox" id="type-instruments" class="item-type-checkbox"><label for="type-instruments">Instruments & Recreations</label></div>
                <div><input type="checkbox" id="type-crafted" class="item-type-checkbox"><label for="type-crafted">Crafted & Collectibles</label></div>
                <div><input type="checkbox" id="type-sports" class="item-type-checkbox"><label for="type-sports">Sports, Fitness & Outdoor</label></div>
              </div>
              <!-- Clear Filters Button -->
              <button id="clear-filters-btn" type="button">Clear Filters</button>
            </div>
      
          <!-- MAIN PRODUCTS SECTION -->
          <div class="main-content">
            <div id="items-container" style="display: flex; flex-wrap: wrap; gap: 20px; overflow-y: auto; max-height: 600px; padding-right: 10px;"></div>
          </div>
        </div>
      
        <!-- SUPABASE SCRIPT -->
        <script>
const supabaseUrl = 'https://wuhgqjeijmxsgvnykttj.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1aGdxamVpam14c2d2bnlrdHRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI4MjkzMDQsImV4cCI6MjA1ODQwNTMwNH0._lZy7CE2A8HM1hatjGYrMR8QAUi8nk4L_EuV7Fojhwg';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// Add real-time subscription to item table changes to refresh item list
supabaseClient
  .channel('public:item')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'item' }, payload => {
    console.log(`Item ${payload.event} event:`, payload);
    fetchAndDisplayItems();
  })
  .subscribe();

// document.addEventListener('DOMContentLoaded', () => {
//     const userName = `${localStorage.getItem('stud_fname')} ${localStorage.getItem('stud_lname')}`;
//     const profileSection = document.querySelector('.profile-section span');
//     if (userName.trim()) {
//         profileSection.innerHTML = `Welcome, ${userName}`;
//     }
// });

        // Removed the entire fetchItems function as it is redundant

const priceMinInput = document.getElementById('price-min');
const priceMaxInput = document.getElementById('price-max');

function updateTimeAgoElements() {
  const elements = document.querySelectorAll('.time-ago');
  const now = new Date();

  elements.forEach(el => {
    const createdAt = el.getAttribute('data-created-at');
    if (!createdAt) return;

    const createdDate = new Date(createdAt);
    const diffInSeconds = Math.floor((now - createdDate) / 1000);

    let timeAgoText = '';
    if (diffInSeconds < 60) {
      timeAgoText = `${diffInSeconds} second${diffInSeconds === 1 ? '' : 's'} ago`;
    } else {
      const diffInMinutes = Math.floor(diffInSeconds / 60);
      if (diffInMinutes < 60) {
        timeAgoText = `${diffInMinutes} minute${diffInMinutes === 1 ? '' : 's'} ago`;
      } else {
        const diffInHours = Math.floor(diffInMinutes / 60);
        if (diffInHours < 24) {
          timeAgoText = `${diffInHours} hour${diffInHours === 1 ? '' : 's'} ago`;
        } else {
          const diffInDays = Math.floor(diffInHours / 24);
          if (diffInDays < 7) {
            timeAgoText = `${diffInDays} day${diffInDays === 1 ? '' : 's'} ago`;
          } else {
            const diffInWeeks = Math.floor(diffInDays / 7);
            if (diffInWeeks < 4) {
              timeAgoText = `${diffInWeeks} week${diffInWeeks === 1 ? '' : 's'} ago`;
            } else {
              const diffInMonths = Math.floor(diffInDays / 30);
              timeAgoText = `${diffInMonths} month${diffInMonths === 1 ? '' : 's'} ago`;
            }
          }
        }
      }
    }

    el.textContent = `Posted: ${timeAgoText}`;
  });
}

// Update time ago elements every 60 seconds
setInterval(updateTimeAgoElements, 60000);

function sanitizeNumericInput(value) {
    // Allow only digits and at most one decimal point
    let sanitized = value.replace(/[^0-9.]/g, '');
    const parts = sanitized.split('.');
    if (parts.length > 2) {
        // More than one decimal point, keep only first
        sanitized = parts[0] + '.' + parts.slice(1).join('');
    }
    return sanitized;
}

    // Removed priceMinInput and priceMaxInput input event listeners to disable immediate filtering on input
    /*
    priceMinInput?.addEventListener('input', () => {
        const sanitizedValue = sanitizeNumericInput(priceMinInput.value);
        if (priceMinInput.value !== sanitizedValue) {
            priceMinInput.value = sanitizedValue;
        }

        const minValRaw = priceMinInput.value.trim();
        const maxValRaw = priceMaxInput.value.trim();

        if (minValRaw === '' && maxValRaw === '') {
            // Both empty, fetch all items (no price filter)
            fetchAndDisplayItems();
            return;
        }
        // If one is empty, treat empty min as 0, empty max as max value
        const minVal = minValRaw === '' ? 0 : parseFloat(minValRaw);
        const maxVal = maxValRaw === '' ? Number.MAX_VALUE : parseFloat(maxValRaw);

        if (isNaN(minVal) || isNaN(maxVal)) {
            // Do not fetch if invalid numbers
            return;
        }

        if (minVal >= maxVal) {
            // Show no items found message if min is greater than or equal to max
            const container = document.getElementById('items-container');
            container.innerHTML = '<p>No items found matching your search and filters.</p>';
            return;
        }

        fetchAndDisplayItems();
        return;
    });

    priceMaxInput?.addEventListener('input', () => {
        const sanitizedValue = sanitizeNumericInput(priceMaxInput.value);
        if (priceMaxInput.value !== sanitizedValue) {
            priceMaxInput.value = sanitizedValue;
        }

        const minValRaw = priceMinInput.value.trim();
        const maxValRaw = priceMaxInput.value.trim();

        if (minValRaw === '' && maxValRaw === '') {
            // Both empty, fetch all items (no price filter)
            fetchAndDisplayItems();
            return;
        }
        // If one is empty, treat empty min as 0, empty max as max value
        const minVal = minValRaw === '' ? 0 : parseFloat(minValRaw);
        const maxVal = maxValRaw === '' ? Number.MAX_VALUE : parseFloat(maxValRaw);

        if (isNaN(minVal) || isNaN(maxVal)) {
            // Do not fetch if invalid numbers
            return;
        }

        if (minVal >= maxVal) {
            // Show no items found message if min is greater than or equal to max
            const container = document.getElementById('items-container');
            container.innerHTML = '<p>No items found matching your filters.</p>';
            return;
        }

        fetchAndDisplayItems();
    });
    */

    // Add event listener for Apply button to trigger filtering with price range logic
    document.getElementById('apply-price-filter').addEventListener('click', () => {
        const priceMinInput = document.getElementById('price-min');
        const priceMaxInput = document.getElementById('price-max');
        const minValRaw = priceMinInput.value.trim();
        const maxValRaw = priceMaxInput.value.trim();

        // If both empty, do nothing (no changes)
        if (minValRaw === '' && maxValRaw === '') {
            // Just fetch all items without price filter
            fetchAndDisplayItems();
            return;
        }

        // Parse min and max with defaults
        const minVal = minValRaw === '' ? 0 : parseFloat(minValRaw);
        const maxVal = maxValRaw === '' ? Number.MAX_VALUE : parseFloat(maxValRaw);

        if (isNaN(minVal) || isNaN(maxVal)) {
            // Invalid input, do nothing
            return;
        }

        if (minVal > maxVal) {
            // Show no items found message if min is greater than max
            const container = document.getElementById('items-container');
            container.innerHTML = '<p>No items found matching your search and filters.</p>';
            return;
        }

        // Valid range, trigger fetch
        fetchAndDisplayItems();
    });
document.getElementById('condition-filter')?.addEventListener('change', fetchAndDisplayItems);
document.getElementById('school-filter')?.addEventListener('change', fetchAndDisplayItems);
document.querySelectorAll('.item-type-checkbox').forEach(checkbox => {
  checkbox.addEventListener('change', fetchAndDisplayItems);
});

// Update notification badge on page load
document.addEventListener('DOMContentLoaded', () => {
    updateNotificationBadge();
});

fetchAndDisplayItems();


supabaseClient
  .channel('public:item')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'item' }, payload => {
    console.log(`Item ${payload.event} event:`, payload);
    fetchAndDisplayItems();
    // Instead of incrementing count locally, fetch fresh count from backend if panel is closed
    if (!notificationPanelIsOpen) {
        updateNotificationBadge();
    }
  })
  .subscribe();


    function logoutUser() {
        // Clear only user-related stored login data, keep recent searches intact
        localStorage.removeItem("stud_id");
        localStorage.removeItem("stud_fname");
        localStorage.removeItem("stud_lname");
        localStorage.removeItem("stud_email");
        localStorage.removeItem("userSchool");
        localStorage.removeItem("isLoggedIn");
        localStorage.removeItem("currentSearchQuery"); // Clear search input on logout

        // Clear saved filters on logout to reset filters on next login
        localStorage.removeItem("filter_school");
        localStorage.removeItem("filter_condition");
        localStorage.removeItem("filter_price_min");
        localStorage.removeItem("filter_price_max");
        localStorage.removeItem("filter_item_types");

        sessionStorage.removeItem("stud_id");

        // Do NOT clear entire localStorage or sessionStorage to preserve recent searches
        // localStorage.clear();
        // sessionStorage.clear();

        // Redirect to login page
        window.location.href = "Login_page.html";
    }
    </script>


<script type="module">
  import Chatbot from "https://cdn.jsdelivr.net/npm/@denserai/embed-chat@1/dist/web.min.js";
  Chatbot.init({
    chatbotId: "809cf4be-ec44-4edc-a65b-51746822a01e",
  });
</script>

  <script>
    // Add click event to open chatbot when Ask AI or AI logo is clicked
    document.getElementById('ask-ai-container').addEventListener('click', () => {
      // Try to find chatbot toggle button or widget container and simulate click
      const chatbotToggleButton = document.querySelector('.denserai-chat-toggle-button');
      const chatbotWidget = document.querySelector('.denserai-chat-widget');

      console.log('Ask AI container clicked');

    if (chatbotToggleButton) {
      chatbotToggleButton.click();
    } else if (window.chatbotInstance && typeof window.chatbotInstance.show === 'function') {
      window.chatbotInstance.show();
    } else if (window.chatbotInstance && typeof window.chatbotInstance.open === 'function') {
      window.chatbotInstance.open();
    } else if (window.Chatbot && typeof window.Chatbot.init === 'function') {
      console.warn('Chatbot toggle button not found. Initializing chatbot instance.');
      window.chatbotInstance = window.Chatbot.init({
        chatbotId: "18b38ed1-d756-4f0d-8276-f55f53108689",
      });
      if (window.chatbotInstance && typeof window.chatbotInstance.show === 'function') {
        window.chatbotInstance.show();
      } else if (window.chatbotInstance && typeof window.chatbotInstance.open === 'function') {
        window.chatbotInstance.open();
      } else {
        console.error('Failed to show chatbot widget after initialization.');
      }
    } else {
      console.error('Chatbot toggle button not found and no suitable Chatbot API method available.');
    }
    });

    document.getElementById('ask-ai-link').addEventListener('click', (event) => {
      event.preventDefault();
      console.log('Ask AI link clicked');
      // Trigger the same click handler as container
      document.getElementById('ask-ai-container').click();
    });


const myConversationsBtn = document.getElementById("myConversationsBtn");
const conversationPanel = document.getElementById("conversationPanel");
const closeConversationPanelBtn = document.getElementById("closeConversationPanel");
// Removed conversationOverlay element and references
// const conversationOverlay = document.getElementById("conversationOverlay");

const notificationsBtn = document.getElementById("notificationsBtn");
const notificationPanel = document.getElementById("notificationPanel");
const transactionFloatBtn = document.getElementById("transactionFloatBtn");
const transactionPanel = document.getElementById("transactionPanel");

function toggleConversationPanel() {
    if (conversationPanel.classList.contains("open")) {
        console.log("Closing conversation panel");
        conversationPanel.classList.remove("open");
        conversationPanel.setAttribute("aria-hidden", "true");
        // Removed overlay hide
        // conversationOverlay.style.display = "none";
    } else {
        console.log("Opening conversation panel");
        // Close notification panel if open
        if (notificationPanel.classList.contains("open")) {
            notificationPanel.classList.remove("open");
            notificationPanel.setAttribute("aria-hidden", "true");
        }
        // Close transaction panel if open
        if (transactionPanel.classList.contains("open")) {
            transactionPanel.classList.remove("open");
            transactionPanel.setAttribute("aria-hidden", "true");
        }
        conversationPanel.classList.add("open");
        conversationPanel.setAttribute("aria-hidden", "false");
        // Removed overlay show
        // conversationOverlay.style.display = "block";
    }
}

function closeConversationPanel() {
    console.log("Closing conversation panel");
    if (conversationPanel.classList.contains("open")) {
        conversationPanel.classList.remove("open");
        conversationPanel.setAttribute("aria-hidden", "true");
        // Removed overlay hide
        // conversationOverlay.style.display = "none";
    } else {
        console.log("Panel already closed");
    }
}


let notificationPanelIsOpen = false;
let newItemNotificationCount = 0; // Track count of new item notifications

// Function to fetch current unread "new item" notifications count from server
async function fetchNewItemNotificationCount() {
    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
        console.warn('No access token found in localStorage');
        // Redirect to login page if no token
        window.location.href = 'Login_page.html';
        return 0;
    }
    try {
        const response = await fetch(`${window.location.origin}/notifications`, {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        });
        if (response.status === 401) {
            // Unauthorized, redirect to login
            window.location.href = 'Login_page.html';
            return 0;
        }
        if (!response.ok) {
            console.error('Failed to fetch notifications:', response.status);
            return 0;
        }
        const data = await response.json();
        let count = 0;
        if (data && data.notifications) {
            for (const notif of data.notifications) {
                if (notif.type === 'new item' && notif.is_read === false) {
                    count += 1;
                }
            }
        }
        return count;
    } catch (error) {
        console.error('Error fetching notifications:', error);
        return 0;
    }
}

async function updateNotificationBadge() {
    const badge = document.getElementById('notificationBadge');
    if (!badge) {
        console.warn('Notification badge element not found');
        return;
    }

    // Always fetch fresh count from backend when updating badge
    newItemNotificationCount = await fetchNewItemNotificationCount();
    console.log('updateNotificationBadge: newItemNotificationCount:', newItemNotificationCount, 'notificationPanelIsOpen:', notificationPanelIsOpen);

    if (!notificationPanelIsOpen && newItemNotificationCount > 0) {
        badge.style.display = 'inline-block';
        badge.textContent = newItemNotificationCount;
        const userSchool = localStorage.getItem('userSchool') || 'your school';
        badge.title = `There ${newItemNotificationCount === 1 ? 'is' : 'are'} ${newItemNotificationCount} new item${newItemNotificationCount > 1 ? 's' : ''} posted in ${userSchool}`;
    } else {
        badge.style.display = 'none';
        badge.textContent = '';
        badge.title = '';
    }
}

async function toggleNotificationPanel() {
    const iframe = document.querySelector('#notificationPanel iframe');
    if (notificationPanel.classList.contains("open")) {
        console.log("Closing notification panel");
        notificationPanel.classList.remove("open");
        notificationPanel.setAttribute("aria-hidden", "true");
        notificationPanelIsOpen = false;
        await updateNotificationBadge();
        // Send message to iframe to mark notifications as read on panel close
        if (iframe && iframe.contentWindow) {
            iframe.contentWindow.postMessage({ type: 'markNotificationsRead' }, '*');
        }
        // Removed overlay hide
        // conversationOverlay.style.display = "none";
    } else {
        console.log("Opening notification panel");
        // Close conversation panel if open
        if (conversationPanel.classList.contains("open")) {
            conversationPanel.classList.remove("open");
            conversationPanel.setAttribute("aria-hidden", "true");
        }
        // Close transaction panel if open
        if (transactionPanel.classList.contains("open")) {
            transactionPanel.classList.remove("open");
            transactionPanel.setAttribute("aria-hidden", "true");
        }
        notificationPanel.classList.add("open");
        notificationPanel.setAttribute("aria-hidden", "false");
        notificationPanelIsOpen = true;  
        // Reset count when panel is opened  
        newItemNotificationCount = 0;  

        // Call backend to update last_checked_at for the user when notification panel is opened  
        try {  
            const token = localStorage.getItem('access_token');  
            if (token) {  
                await fetch(`${window.location.origin}/notifications/last-checked`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
            }  
        } catch (err) {  
            console.error('Error updating last_checked_at on panel open:', err);  
        }  

        await updateNotificationBadge();  
        // Send message to iframe to clear displayedNotificationIds before reloading notifications  
        if (iframe && iframe.contentWindow) {  
            iframe.contentWindow.postMessage({ type: 'clearDisplayedNotificationIds' }, '*');  
            iframe.contentWindow.postMessage({ type: 'reloadNotifications' }, '*');  
        }  
        // Removed overlay show  
        // conversationOverlay.style.display = "block";  
    }  
}

function closeNotificationPanel() {
    console.log("Closing notification panel");
    if (notificationPanel.classList.contains("open")) {
        notificationPanel.classList.remove("open");
        notificationPanel.setAttribute("aria-hidden", "true");
        // Removed overlay hide
        // conversationOverlay.style.display = "none";
    } else {
        console.log("Notification panel already closed");
    }
}

function toggleTransactionPanel() {
    if (transactionPanel.classList.contains("open")) {
        console.log("Closing transaction panel");
        transactionPanel.classList.remove("open");
        transactionPanel.setAttribute("aria-hidden", "true");
        // Removed overlay hide
        // conversationOverlay.style.display = "none";
    } else {
        console.log("Opening transaction panel");
        // Close conversation panel if open
        if (conversationPanel.classList.contains("open")) {
            conversationPanel.classList.remove("open");
            conversationPanel.setAttribute("aria-hidden", "true");
        }
        // Close notification panel if open
        if (notificationPanel.classList.contains("open")) {
            notificationPanel.classList.remove("open");
            notificationPanel.setAttribute("aria-hidden", "true");
        }
        transactionPanel.classList.add("open");
        transactionPanel.setAttribute("aria-hidden", "false");
        // Removed overlay show
        // conversationOverlay.style.display = "block";
    }
}

function closeTransactionPanel() {
    console.log("Closing transaction panel");
    if (transactionPanel.classList.contains("open")) {
        transactionPanel.classList.remove("open");
        transactionPanel.setAttribute("aria-hidden", "true");
        // Removed overlay hide
        // conversationOverlay.style.display = "none";
    } else {
        console.log("Transaction panel already closed");
    }
}

myConversationsBtn.addEventListener("click", toggleConversationPanel);
if (notificationsBtn) {
  notificationsBtn.addEventListener("click", toggleNotificationPanel);
}
if (transactionFloatBtn) {
  transactionFloatBtn.addEventListener("click", toggleTransactionPanel);
}

// Removed event listener for closeConversationPanelBtn as the button was removed
// Removed overlay click event listener
// conversationOverlay.addEventListener("click", () => {
//     closeConversationPanel();
//     closeNotificationPanel();
//     closeTransactionPanel();
// });

const notificationsFloatBtn = document.getElementById("notificationsFloatBtn");
notificationsFloatBtn.addEventListener("click", toggleNotificationPanel);

const transactionFloatBtn2 = document.getElementById("transactionFloatBtn");
transactionFloatBtn2.addEventListener("click", toggleTransactionPanel);

document.addEventListener('DOMContentLoaded', () => {
    // Check URL parameter to open conversation panel automatically
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('openConversations') === '1') {
        if (!conversationPanel.classList.contains('open')) {
            conversationPanel.classList.add('open');
            conversationPanel.setAttribute('aria-hidden', 'false');
            // Removed overlay show
            // conversationOverlay.style.display = 'block';
        }
    }
});
    </script>
  </body>

  <!-- Modal for Detailed Post -->
  <div id="detailedPostModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background-color: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center;">
    <div style="position: relative; width: 90%; max-width: 900px; height: 90%; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
      <button id="closeDetailedPostModal" style="position: absolute; top: 10px; right: 10px; background: #069210; color: white; border: none; border-radius: 5px; padding: 8px 12px; font-size: 16px; cursor: pointer; z-index: 2100;">Close</button>
      <iframe id="detailedPostIframe" src="" style="flex-grow: 1; border: none; border-radius: 0 0 10px 10px;"></iframe>
    </div>
  </div>

  <!-- Feedback Popup Container -->
  <div id="feedbackPopupContainer" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background-color: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center;">
    <div id="feedbackPopup" style="background: white; border-radius: 8px; padding: 20px; width: 90%; max-width: 400px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); position: relative;">
      <button id="closeFeedbackPopupBtn" title="Close" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #069210;">&times;</button>
      <h2 style="margin-top: 0; color: #069210; text-align: center;">Submit Feedback</h2>
      <div class="stars" id="starContainer" style="display: flex; justify-content: center; margin-bottom: 15px;">
        <span class="star" data-value="1" style="font-size: 30px; color: #ccc; cursor: pointer; margin: 0 5px;">&#9733;</span>
        <span class="star" data-value="2" style="font-size: 30px; color: #ccc; cursor: pointer; margin: 0 5px;">&#9733;</span>
        <span class="star" data-value="3" style="font-size: 30px; color: #ccc; cursor: pointer; margin: 0 5px;">&#9733;</span>
        <span class="star" data-value="4" style="font-size: 30px; color: #ccc; cursor: pointer; margin: 0 5px;">&#9733;</span>
        <span class="star" data-value="5" style="font-size: 30px; color: #ccc; cursor: pointer; margin: 0 5px;">&#9733;</span>
      </div>
      <textarea id="feedbackComment" placeholder="Write your comment here..." style="width: 100%; height: 80px; resize: none; border-radius: 5px; border: 1px solid #ccc; padding: 8px; font-size: 14px; margin-bottom: 15px; box-sizing: border-box;"></textarea>
      <button id="submitFeedbackBtn" disabled style="background-color: #069210; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px;">Submit</button>
      <div id="feedbackMessage" style="text-align: center; margin-top: 10px; color: green; font-weight: bold;"></div>
    </div>
  </div>

  <script>
    (function() {
      const feedbackPopupContainer = document.getElementById('feedbackPopupContainer');
      const closeBtn = document.getElementById('closeFeedbackPopupBtn');
      const stars = feedbackPopupContainer.querySelectorAll('.star');
      const submitBtn = document.getElementById('submitFeedbackBtn');
      const commentInput = document.getElementById('feedbackComment');
      const messageDiv = document.getElementById('feedbackMessage');

      let selectedStars = 0;
      let currentItemId = null;
      let currentSellerId = null;

      function updateStarsDisplay() {
        stars.forEach(star => {
          const value = parseInt(star.getAttribute('data-value'));
          if (value <= selectedStars) {
            star.style.color = '#FFD700';
          } else {
            star.style.color = '#ccc';
          }
        });
        submitBtn.disabled = selectedStars === 0;
      }

      stars.forEach(star => {
        star.addEventListener('click', () => {
          selectedStars = parseInt(star.getAttribute('data-value'));
          updateStarsDisplay();
        });
        star.addEventListener('mouseover', () => {
          const hoverValue = parseInt(star.getAttribute('data-value'));
          stars.forEach(s => {
            const value = parseInt(s.getAttribute('data-value'));
            s.style.color = value <= hoverValue ? '#FFD700' : '#ccc';
          });
        });
        star.addEventListener('mouseout', () => {
          updateStarsDisplay();
        });
      });

      closeBtn.addEventListener('click', () => {
        feedbackPopupContainer.style.display = 'none';
        resetForm();
      });

      function resetForm() {
        selectedStars = 0;
        updateStarsDisplay();
        commentInput.value = '';
        messageDiv.textContent = '';
        messageDiv.style.color = 'green';
        submitBtn.disabled = true;
        currentItemId = null;
        currentSellerId = null;
      }

window.openFeedbackPopup = function(itemId, sellerId) {
  resetForm();
  currentItemId = itemId;
  currentSellerId = sellerId;
  feedbackPopupContainer.style.display = 'flex';
};

      submitBtn.addEventListener('click', async () => {
        submitBtn.disabled = true;
        messageDiv.textContent = '';
        const comment = commentInput.value.trim();

        let studId = localStorage.getItem('stud_id');
        console.log('Submitting feedback with:', { currentItemId, currentSellerId, studId, selectedStars, comment });
        if (!studId) {
          alert('User not logged in. Redirecting to login page.');
          window.location.href = 'Login_page.html';
          return;
        }
        if (!currentItemId) {
          messageDiv.style.color = 'red';
          messageDiv.textContent = 'Invalid item ID. Cannot submit feedback.';
          submitBtn.disabled = false;
          return;
        }
        if (!currentSellerId) {
          messageDiv.style.color = 'red';
          messageDiv.textContent = 'Invalid seller ID. Cannot submit feedback.';
          submitBtn.disabled = false;
          return;
        }
        if (selectedStars < 1 || selectedStars > 5) {
          messageDiv.style.color = 'red';
          messageDiv.textContent = 'Please select a valid star rating.';
          submitBtn.disabled = false;
          return;
        }

        studId = parseInt(studId, 10);
        const sellerIdInt = parseInt(currentSellerId, 10);

        try {
          const { error } = await supabaseClient
            .from('feedback')
            .insert({
              item_id: currentItemId,
              buyer_id: studId,
              seller_id: sellerIdInt,
              stars: selectedStars,
              comment: comment,
              created_at: new Date().toISOString()
            });

          if (error) {
            console.error('Error submitting feedback:', error);
            messageDiv.style.color = 'red';
            messageDiv.textContent = 'Failed to submit feedback. Please try again.';
            submitBtn.disabled = false;
            return;
          }

          messageDiv.style.color = 'green';
          messageDiv.textContent = 'Feedback submitted successfully!';
          setTimeout(() => {
            feedbackPopupContainer.style.display = 'none';
            resetForm();
          }, 1500);
        } catch (err) {
          console.error('Unexpected error submitting feedback:', err);
          messageDiv.style.color = 'red';
          messageDiv.textContent = 'Failed to submit feedback due to unexpected error.';
          submitBtn.disabled = false;
        }
      });
    })();
  </script>

  <!-- Modal for Post Item -->
  <div id="postItemModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background-color: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center;">
    <div style="position: relative; width: 90%; max-width: 900px; height: 90%; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
      <button id="closePostItemModal" style="position: absolute; top: 10px; right: 10px; background: #069210; color: white; border: none; border-radius: 5px; padding: 8px 12px; font-size: 16px; cursor: pointer; z-index: 2200;">Close</button>
      <iframe id="postItemIframe" src="" style="flex-grow: 1; border: none; border-radius: 0 0 10px 10px;"></iframe>
    </div>
  </div>

  <script>
    document.getElementById('closeDetailedPostModal').addEventListener('click', () => {
      const modal = document.getElementById('detailedPostModal');
      const iframe = document.getElementById('detailedPostIframe');
      iframe.src = '';
      modal.style.display = 'none';
    });

    document.getElementById('closePostItemModal').addEventListener('click', () => {
      const modal = document.getElementById('postItemModal');
      const iframe = document.getElementById('postItemIframe');
      iframe.src = '';
      modal.style.display = 'none';
    });

    // Clear iframe src on modal close to avoid stale content
    window.addEventListener('beforeunload', () => {
      const detailedIframe = document.getElementById('detailedPostIframe');
      if (detailedIframe) {
        detailedIframe.src = '';
      }
      const postItemIframe = document.getElementById('postItemIframe');
      if (postItemIframe) {
        postItemIframe.src = '';
      }
      
    });

    // Ensure modals are hidden and iframe src cleared on page load to prevent empty modal showing
    document.addEventListener('DOMContentLoaded', () => {
      const detailedModal = document.getElementById('detailedPostModal');
      const detailedIframe = document.getElementById('detailedPostIframe');
      if (detailedModal) detailedModal.style.display = 'none';
      if (detailedIframe) detailedIframe.src = '';

      const postItemModal = document.getElementById('postItemModal');
      const postItemIframe = document.getElementById('postItemIframe');
      if (postItemModal) postItemModal.style.display = 'none';
      if (postItemIframe) postItemIframe.src = '';
    });

    // Open post_item.html in modal iframe when clicking Post Item link
    document.getElementById('postItemLink').addEventListener('click', (event) => {
      event.preventDefault();
      const modal = document.getElementById('postItemModal');
      const iframe = document.getElementById('postItemIframe');
      iframe.src = 'post_item.html';
      modal.style.display = 'flex';
    });

    // Listen for messages from iframe to navigate profile inside modal iframe
    window.addEventListener('message', (event) => {
      console.log('Message received in index.html:', event.data);
      if (!event.data) return;

      // Handle message to close the Post Item modal
      if (event.data.type === 'closePostItemModal') {
        console.log('Received closePostItemModal message, attempting to close modal.');
        const modal = document.getElementById('postItemModal');
        const iframe = document.getElementById('postItemIframe');
        if (modal) {
          modal.style.display = 'none';
        }
        if (iframe) {
          iframe.src = ''; // Clear iframe source
        }
      } else if (event.data.type === 'navigateProfile') {
        const url = event.data.url;
        const modal = document.getElementById('detailedPostModal');
        const iframe = document.getElementById('detailedPostIframe');
        if (modal && iframe) {
          iframe.src = url;
          if (modal.style.display !== 'flex') {
            modal.style.display = 'flex';
          }
        }
      } else if (event.data.type === 'showDetailedPostModal') {
        // Show the detailed post modal
        const modal = document.getElementById('detailedPostModal');
        if (modal) {
          modal.style.display = 'flex';
        }
        // Optionally, set iframe src to current detailed post if needed
        // If iframe src is empty, reload or keep as is
      }
    });
  </script>

  <script>
    // Add event listener for Clear Filters button
document.getElementById('clear-filters-btn').addEventListener('click', () => {
  // Do NOT clear search input or currentSearchQuery to preserve searched item

  // Clear price inputs
  const priceMinInput = document.getElementById('price-min');
  const priceMaxInput = document.getElementById('price-max');
  if (priceMinInput) {
    priceMinInput.value = '';
    localStorage.removeItem('filter_price_min');
  }
  if (priceMaxInput) {
    priceMaxInput.value = '';
    localStorage.removeItem('filter_price_max');
  }

  // Clear condition filter
  const conditionFilter = document.getElementById('condition-filter');
  if (conditionFilter) {
    conditionFilter.value = '';
    localStorage.removeItem('filter_condition');
  }

  // Clear school filter
  const schoolFilter = document.getElementById('school-filter');
  if (schoolFilter) {
    schoolFilter.value = '';
    localStorage.removeItem('filter_school');
  }

  // Clear item type checkboxes
  const itemTypeCheckboxes = document.querySelectorAll('.item-type-checkbox');
  itemTypeCheckboxes.forEach(checkbox => {
    checkbox.checked = false;
  });
  localStorage.removeItem('filter_item_types');

  // Fetch and display all items with cleared filters
  fetchAndDisplayItems();
});
  </script>

  <script>
    // Listen for messages from child iframes to open detailed post modal or feedback popup
    window.addEventListener('message', (event) => {
      if (!event.data) return;
      if (event.data.type === 'openDetailedPostModal' && event.data.itemId) {
        const itemId = event.data.itemId;
        const modal = document.getElementById('detailedPostModal');
        const iframe = document.getElementById('detailedPostIframe');
        iframe.src = `Detailed_post.html?item_id=${itemId}&embedded=1`;
        modal.style.display = 'flex';
      } else if (event.data.type === 'openFeedbackPopup' && event.data.itemId) {
        // Open the feedback popup with itemId and sellerId
        if (typeof window.openFeedbackPopup === 'function') {
          if (!event.data.sellerId) {
            console.warn('Warning: sellerId is missing in openFeedbackPopup event data');
          }
          window.openFeedbackPopup(event.data.itemId, event.data.sellerId || null);
        }
      }
    });

    // Close button event listener for detailed post modal
    document.addEventListener('DOMContentLoaded', () => {
      const closeBtn = document.getElementById('closeDetailedPostModal');
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          const modal = document.getElementById('detailedPostModal');
          const iframe = document.getElementById('detailedPostIframe');
          iframe.src = '';
          modal.style.display = 'none';
        });
      }
    });
  </script>

  <script>
    // On page load, check URL parameters for item_id and seller_id to open feedback popup
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const itemId = urlParams.get('item_id');
      const sellerId = urlParams.get('seller_id');
      if (itemId && sellerId) {
        if (typeof window.openFeedbackPopup === 'function') {
          window.openFeedbackPopup(itemId, sellerId);
          // Remove the query parameters from URL without reloading
          if (window.history && window.history.replaceState) {
            const cleanUrl = window.location.origin + window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
          }
        }
      }
    });
    
  </script>

<script>
  window.addEventListener('load', function() {
  const loader = document.getElementById('pageLoader');
  if (loader) loader.style.display = 'none';
});
  </script>
</html>
